<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
    
    <title>snpdb_modules &mdash; PROJECT-NAME RELEASE documentation</title>
    
    <link rel="stylesheet" type="text/css" href="../_static/css/spc-bootstrap.css">
    <link rel="stylesheet" type="text/css" href="../_static/css/spc-extend.css">
    <link rel="stylesheet" href="../_static/bioinformatics.css" type="text/css" >
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" >
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     'RELEASE',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/js/copybutton.js"></script>
    <link rel="top" title="PROJECT-NAME RELEASE documentation" href="../index.html" >
    <link rel="up" title="Module code" href="index.html" > 
  </head>
  <body>

<div class="container">
  <div class="top-scipy-org-logo-header">
    <a href="../index.html">
      <img style="border: 0;" alt="SciPy" src="../_static/img/phe_colour_logo.gif"></a>
    </div>
  </div>
</div>


    <div class="container">
      <div class="main">
        
	<div class="row-fluid">
	  <div class="span12">
	    <div class="spc-navbar">
              
    <ul class="nav nav-pills pull-left">
        <li class="active"><a href="http://158.119.147.111/docs">Bioinformatics Docs</a></li>
	
        <li class="active"><a href="../index.html">PROJECT-NAME RELEASE documentation</a></li>
	
          <li class="active"><a href="index.html" accesskey="U">Module code</a></li> 
    </ul>
              
              
    <ul class="nav nav-pills pull-right">
      <li class="active">
        <a href="../genindex.html" title="General Index"
           accesskey="I">index</a>
      </li>
    </ul>
              
	    </div>
	  </div>
	</div>
        

	<div class="row-fluid">
          <div class="span9">
            
        <div class="bodywrapper">
          <div class="body" id="spc-section-body">
            
  <h1>Source code for snpdb_modules</h1><div class="highlight"><pre>
<span class="n">__author__</span> <span class="o">=</span> <span class="s">&#39;flashton&#39;</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">psycopg2</span>
<span class="kn">import</span> <span class="nn">make_snpdb_queries</span>

<div class="viewcode-block" id="SNPdb"><a class="viewcode-back" href="../snpdb.html#snpdb_modules.SNPdb">[docs]</a><span class="k">class</span> <span class="nc">SNPdb</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Some really insteresting documnetation about the awesome class that this is!</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    To use this in your code do the following:</span>

<span class="sd">        &gt;&gt;&gt; from blah import SNPdb</span>
<span class="sd">        &gt;&gt;&gt; db = SNPdb(config=&quot;/path&quot;)</span>
<span class="sd">        &gt;&gt;&gt; db.get_matrix()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">path_to_config</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;Path to the config&quot;&quot;&quot;</span>
    <span class="n">snpdb_name</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;Name of the database&quot;&quot;&quot;</span>

    <span class="n">reference_genome</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">pg_uname</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">pg_pword</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">pg_host</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">conn_string</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="SNPdb.__init__"><a class="viewcode-back" href="../snpdb.html#snpdb_modules.SNPdb.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor for the SNPdb class. If config is specified, then it will always be used to initialise</span>
<span class="sd">            the connection.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        config: str</span>
<span class="sd">            Path to the config file.</span>
<span class="sd">        uname: str</span>
<span class="sd">            Username to be used for the db.</span>

<span class="sd">        See also</span>
<span class="sd">        --------</span>

<span class="sd">        __N.B.__ Some interesting note goes here.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;config&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path_to_config</span> <span class="o">=</span> <span class="n">config</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_config</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pg_uname</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;uname&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">path_to_config</span> <span class="o">=</span> <span class="n">path_to_config</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snpdb_name</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reference_genome</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pg_uname</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pg_pword</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pg_host</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn_string</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_conn_string</span><span class="p">())</span>


    <span class="c"># def __init__(self, path_to_config):</span>
    <span class="c">#     self.path_to_config = path_to_config</span>
    <span class="c">#     self.snpdb_name = None</span>
    <span class="c">#     self.reference_genome = None</span>
    <span class="c">#     self.pg_uname = None</span>
    <span class="c">#     self.pg_pword = None</span>
    <span class="c">#     self.pg_host = None</span>
    <span class="c">#     self.conn_string = None</span>
</div>
<div class="viewcode-block" id="SNPdb.parse_config"><a class="viewcode-back" href="../snpdb.html#snpdb_modules.SNPdb.parse_config">[docs]</a>    <span class="k">def</span> <span class="nf">parse_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_to_config</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fi</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fi</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;reference_genome&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reference_genome</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;snpdb_name&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">snpdb_name</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;pg_uname&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pg_uname</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;pg_pword&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pg_pword</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;pg_host&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pg_host</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;Cannot find {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_to_config</span><span class="p">)</span>


</div>
<div class="viewcode-block" id="SNPdb._write_conn_string"><a class="viewcode-back" href="../snpdb.html#snpdb_modules.SNPdb._write_conn_string">[docs]</a>    <span class="k">def</span> <span class="nf">_write_conn_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn_string</span> <span class="o">=</span> <span class="s">&#39;host=</span><span class="se">\&#39;</span><span class="s">{0}</span><span class="se">\&#39;</span><span class="s"> dbname={1} user=</span><span class="se">\&#39;</span><span class="s">{2}</span><span class="se">\&#39;</span><span class="s"> password=</span><span class="se">\&#39;</span><span class="s">{3}</span><span class="se">\&#39;</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pg_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">snpdb_name</span><span class="p">,</span>
                                                                                          <span class="bp">self</span><span class="o">.</span><span class="n">pg_uname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pg_pword</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SNPdb.check_if_snpdb_exists"><a class="viewcode-back" href="../snpdb.html#snpdb_modules.SNPdb.check_if_snpdb_exists">[docs]</a>    <span class="k">def</span> <span class="nf">check_if_snpdb_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn_string</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">except</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="SNPdb.make_snpdb"><a class="viewcode-back" href="../snpdb.html#snpdb_modules.SNPdb.make_snpdb">[docs]</a>    <span class="k">def</span> <span class="nf">make_snpdb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">does_snpdb_exist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_if_snpdb_exists</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">does_snpdb_exist</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;This snpdb already exists&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;The SNPdb {0} does not exist - running sql to  make snpdb&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snpdb_name</span><span class="p">)</span>

            <span class="n">make_db_conn_string</span> <span class="o">=</span> <span class="s">&#39;host=</span><span class="se">\&#39;</span><span class="s">{0}</span><span class="se">\&#39;</span><span class="s"> dbname=postgres user=</span><span class="se">\&#39;</span><span class="s">{1}</span><span class="se">\&#39;</span><span class="s"> password=</span><span class="se">\&#39;</span><span class="s">{2}</span><span class="se">\&#39;</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pg_host</span><span class="p">,</span>
                                                                                          <span class="bp">self</span><span class="o">.</span><span class="n">pg_uname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pg_pword</span><span class="p">)</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">make_db_conn_string</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="n">psycopg2</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">ISOLATION_LEVEL_AUTOCOMMIT</span><span class="p">)</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;CREATE DATABASE {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snpdb_name</span><span class="p">))</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">conn_string</span> <span class="o">=</span> <span class="s">&#39;host=</span><span class="se">\&#39;</span><span class="s">{0}</span><span class="se">\&#39;</span><span class="s"> dbname={1} user=</span><span class="se">\&#39;</span><span class="s">{2}</span><span class="se">\&#39;</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pg_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">snpdb_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pg_uname</span><span class="p">)</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">conn_string</span><span class="p">)</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">make_snpdb_queries</span><span class="o">.</span><span class="n">cluster_logs</span><span class="p">)</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div></div></div>

          </div>
        </div>
          </div>
      <div class="spc-rightsidebar span3">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/scipyshiny_small.png" alt="Logo">
            </a></p>

        </div>
      </div>
        </div>
      </div>
    </div>

    <div class="container container-navbar-bottom">
      <div class="spc-navbar">
        
      </div>
    </div>
    <div class="container">
    <div class="footer">
    <div class="row-fluid">
    <ul class="inline pull-left">
      <li>
        &copy; Copyright 2013, Surya Kasturi and Pauli Virtanen.
      </li>
      <li>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2.1.
      </li>
    </ul>
    </div>
    </div>
    </div>
  </body>
</html>